# Система управления персоналом «Всё записано»
Вы работаете в растущей IT-компании Dream Big. Специализация компании — разработка программного обеспечения на заказ. Десятки сотрудников каждый день без устали трудятся над самыми разнообразными проектами: от скромных приложений до грандиозных платформ. 
Вы попивали кофе во время перерыва, когда ворвался взъерошенный тимлид Арсений с новой горящей задачей — нужно автоматизировать некоторые процессы в Dream Big для внутренней системы управления персоналом под кодовым названием «Всё записано».
В компании есть база данных PostgreSQL с детализированной информацией о сотрудниках, проектах и логах времени. Сейчас структуре БД и механизмам запросов не хватает гибкости и производительности. Кроме того, политика безопасности проекта гласит: все запросы выполняются строго через функции и процедуры, сырые запросы к таблицам — запрещены.

## Задания
### <a href='https://github.com/YaroslavButorin/everything_is_recorded/blob/main/practicum_sql_for_dev_vse_zapisano.pdf'>Описание БД</a>
#### Задание 1<br>
В Dream Big ежемесячно оценивают производительность сотрудников. В результате бывает, кому-то повышают, а изредка понижают почасовую ставку.<br>
Напишите хранимую процедуру update_employees_rate, которая обновляет почасовую ставку сотрудников на определённый процент. При понижении ставка не может быть ниже минимальной — 500 рублей в час. Если по расчётам выходит меньше, устанавливают минимальную ставку.<br>
#### Задание 2<br>
С ростом доходов компании и учётом ежегодной инфляции Dream Big индексирует зарплату всем сотрудникам.<br>
Напишите хранимую процедуру indexing_salary, которая повышает зарплаты всех сотрудников на определённый процент. <br>
Процедура принимает один целочисленный параметр — процент индексации p. Сотрудникам, которые получают зарплату по ставке ниже средней относительно всех сотрудников до индексации, начисляют дополнительные 2% (p + 2). Ставка остальных сотрудников увеличивается на p%.<br>
Зарплата хранится в БД в типе данных integer, поэтому если в результате повышения зарплаты образуется дробное число, его нужно округлить до целого.<br>
#### Задание 3<br>
Завершая проект, нужно сделать два действия в системе учёта:<br>
Изменить значение поля is_active в записи проекта на false — чтобы рабочее время по этому проекту больше не учитывалось.<br>
Посчитать бонус, если он есть — то есть распределить неизрасходованное время между всеми членами команды проекта. Неизрасходованное время — это разница между временем, которое выделили на проект (estimated_time), и фактически потраченным. Если поле estimated_time не задано, бонусные часы не распределятся. Если отработанных часов нет — расчитывать бонус не нужно.
Разберёмся с бонусом. <br>
Если в момент закрытия проекта estimated_time:<br>
не NULL,<br>
больше суммы всех отработанных над проектом часов,<br>
всем членам команды проекта начисляют бонусные часы.<br>
Размер бонуса считают так: 75% от сэкономленных часов делят на количество участников проекта, но не более 16 бонусных часов на сотрудника. Дробные значения округляют в меньшую сторону (например, 3.7 часа округляют до 3). Рабочие часы заносят в логи с текущей датой. <br>
Например, если на проект запланировали 100 часов, а сделали его за 30 — 3/4 от сэкономленных 70 часов распределят бонусом между участниками проекта.<br>
Создайте пользовательскую процедуру завершения проекта close_project. Если проект уже закрыт, процедура должна вернуть ошибку без начисления бонусных часов.<br>
#### Задание 4<br>
Напишите процедуру log_work для внесения отработанных сотрудниками часов. Процедура добавляет новые записи о работе сотрудников над проектами.<br>
Процедура принимает id сотрудника, id проекта, дату и отработанные часы и вносит данные в таблицу logs. <br>
Если проект завершён, добавить логи нельзя — процедура должна вернуть ошибку Project closed. Количество залогированных часов может быть в этом диапазоне: от 1 до 24 включительно — нельзя внести менее 1 часа или больше 24. Если количество часов выходит за эти пределы, необходимо вывести предупреждение о недопустимых данных и остановить выполнение процедуры.<br>
Запись помечается флагом required_review, если:<br>
залогированно более 16 часов за один день — Dream Big заботится о здоровье сотрудников;<br>
запись внесена будущим числом;<br>
запись внесена более ранним числом, чем на неделю назад от текущего дня — например, если сегодня 10.04.2023, все записи старше 3.04.2023 получат флажок.<br>
#### Задание 5<br>
Чтобы бухгалтерия корректно начисляла зарплату, нужно хранить историю изменения почасовой ставки сотрудников. Создайте отдельную таблицу employee_rate_history с такими столбцами:<br>
id — id записи,<br>
employee_id — id сотрудника,<br>
rate — почасовая ставка сотрудника,<br>
from_date — дата назначения новой ставки.<br>
Внесите в таблицу текущие данные всех сотрудников. В качестве from_date используйте дату основания компании: '2020-12-26'.<br>
Напишите триггерную функцию save_employee_rate_history и триггер change_employee_rate. При добавлении сотрудника в таблицу employees и изменении ставки сотрудника триггер автоматически вносит запись в таблицу employee_rate_history из трёх полей: id сотрудника, его ставки и текущей даты.<br>
#### Задание 6<br>
После завершения каждого проекта Dream Big проводит корпоративную вечеринку, чтобы отпраздновать очередной успех и поощрить сотрудников. Тех, кто посвятил проекту больше всего часов, награждают премией «Айтиголик» — они получают почётные грамоты и ценные подарки от заказчика.<br>
Чтобы вычислить айтиголиков проекта, напишите функцию best_project_workers.<br>
Функция принимает id проекта и возвращает таблицу с именами трёх сотрудников, которые залогировали максимальное количество часов в этом проекте. Результирующая таблица состоит из двух полей: имени сотрудника и количества часов, отработанных на проекте.<br>
#### Задание 6* (необязательное)<br>
Это задание — необязательно для сдачи проекта. Вы можете по желанию — пропустить его или сделать и получить обратную связь от ревьюера.<br>
Доработайте функцию best_project_workers.<br>
Если обнаружится несколько сотрудников с одинаковым количеством залогированных часов, первым становится тот, кто залогировал больше дней. Если и этот параметр совпадёт, сотрудники в списке выводятся в рандомном порядке. Максимальное количество человек в списке — три.<br>
#### Задание 7<br>
К вам заглянул утомлённый главный бухгалтер Марк Захарович с лёгкой синевой под глазами и попросил как-то автоматизировать расчёт зарплаты, пока бухгалтерия не испустила дух.<br>
Напишите для бухгалтерии функцию calculate_month_salary для расчёта зарплаты за месяц.<br>
Функция принимает в качестве параметров даты начала и конца месяца и возвращает результат в виде таблицы с четырьмя полями: id (сотрудника), employee (имя сотрудника), worked_hours и salary.<br>
Процедура суммирует все залогированные часы за определённый месяц и умножает на актуальную почасовую ставку сотрудника. Исключения — записи с флажками required_review и is_paid.<br>
Если суммарно по всем проектам сотрудник отработал более 160 часов в месяц, все часы свыше 160 оплатят с коэффициентом 1.25.<br>
#### Задание 7* (необязательное)<br>
Это задание — необязательно для сдачи проекта. Вы можете по желанию — пропустить его или сделать и получить обратную связь от ревьюера.<br>
Доработайте функцию calculate_month_salary.<br>
Если у сотрудника есть флажки required_review, при выполнении функции появится предупреждение: Warning! Employee % hours must be reviewed!.<br>
На часы, не требующие проверки менеджера, это не повлияет — зарплату за них начислят в обычном режиме.<br>
